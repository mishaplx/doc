# Общие положения

RLS (Row Level Security) - защита данных на уровне строк средствами базы данных.

Для реализации RLS политики используется отдельное подключение к БД (RLS-подключение, RLS-пользователь).

RLS-подключение используется если:
- поле БД sad.emp.is_admin = false

В иных случаях используется подключение администратора (без RLS политики)
См. файл: src/database/tenancy/tenancy.utils.ts - getDataSourceCorrect

RLS политика применяется ТОЛЬКО на таблицы projects, doc, jobs

При обращении к базе данных через RLS-подключение back устанавливает переменную сессии БД-окружения rls.emp_id (значение берется из токена пользователя, инициировавшего запрос пользователя. Поле curremt_emp_id)
См. файл: src/database/tenancy/tenancy.module.ts - dataSourceFactory.useFactory

RLS политика использует rls.emp_id как основу для вычисления доступности записи.


# RLS политика
Представляет серию логических ИЛИ условий. Соблюдение мигнимум одного из них делает запись доступной

Запись доступна:
- создателю и автору записи - право чтения/записи
- исполнителям проекта, документа, поручения - право чтения/записи
- отдельным назначениям из таблицы sad.rls_access_emp - право записи определяется признаком read_only
- отдельным группам из таблицы sad.rls_access_group - право записи определяется признаком read_only

# ВАЖНО
При обработке запроса пользователя после выполнения методов resolver и service запускается процесс подготовки
данных для отправки на фронт. В ходе данного процесса используется повторно инициализированное соединение
DATA_SOURCE, которое использовано в service.

Но при этом переменная БД окружения rls.emp_id (время ее жизни - сессия) НЕ ВОССТАНАВЛИВАЕТСЯ.
Поэтому принято дискуссионное решение: при отсутствии значения данной переменной - предоставить доступ.


# Настройка RLS
- "npm run config:set" - настроить RLS (пользователь, роль, политики)
- "npm run config:del" - удалить RLS
- в переменных back-окружения установить:
  -- DB_LOGIN_RLS и DB_PASS_RLS.


# Иное
Функции back cron не используют RLS-подключение


