# Общие положения

Файлы хранятся в VOLUME

Ссылка на файл в хранится в таблице file_item

При сохранении файлы могут сжиматься (устанавливается признак file_item.compress), а при чтении - разархивироваться

Файл может быть основным (file_item.main = true) или зависимым (file_item.main = false) - то есть PDF образ основного файла

Каждая запись в file_item ссылается на таблицу file_version

Запись в file_version может иметь не более двух записей в file_item (основной и зависимый файлы)

Каждая запись в file_version ссылается на таблицу file_block.

Таким образом, файл может иметь множество версий, а каждая из версий - PDF-образ.

Каждый основной или зависимый файл может быть подписан много раз (связь file_item с таблицей sign)


# Работа с CRON
При загрузке основного файла:
1. устанавливается отложенная задача "извлечь контент" (признак file_version.task_main_content)
2. если загружается файл не PDF - устанавливается отложенная задача "создать образ PDF" (признак file_version.task_pdf_create)
3. если загружается файл PDF (а также при загрузке зависимого файла, который всегда PDF) - устанавливается отложенная задача "определить формат PDF" (признак file_item.task_pdf_format)
4. если при выполнении любой задачи возникает ошибка - устанавливается признак fail_... Задача при этом не снимается

# ВАЖНО
Основные процедуры вынесены в утилиты с аргументом dataSource

Это необходимо для возможности их вызова как при поступлении запроса (scope: Scope.REQUEST), так и в CRON (scope: Scope.DEFAULT)